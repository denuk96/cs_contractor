<div class="container mt-4">
  <h1 class="mb-4">Trending Skin Items</h1>

  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: root_path, method: :get, class: "row g-3" do |f| %>
        <div class="col-md-3">
          <%= f.label :name, "Item Name", class: "form-label" %>
          <%= f.text_field :name, value: params[:name], class: "form-control", placeholder: "Search by name..." %>
        </div>
        <div class="col-md-3">
          <%= f.label :category, "Category", class: "form-label" %>
          <%= f.select :category, Skin::ITEM_TYPES, { include_blank: "All Categories", selected: params[:category] }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= f.label :rarity, class: "form-label" %>
          <%= f.select :rarity, SkinItem.rarities.to_a, { include_blank: "All Rarities", selected: params[:rarity] }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= f.label :sort_by, "Sort By", class: "form-label" %>
          <%= f.select :sort_by, [["Trending Score", ""], ["Price: Low to High", "price_asc"], ["Price: High to Low", "price_desc"], ["No Sorting", "none"]], { selected: params[:sort_by] }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= f.label :min_price, "Min Price", class: "form-label" %>
          <%= f.number_field :min_price, value: params[:min_price], class: "form-control", step: 0.01 %>
        </div>
        <div class="col-md-3">
          <%= f.label :max_price, "Max Price", class: "form-label" %>
          <%= f.number_field :max_price, value: params[:max_price], class: "form-control", step: 0.01 %>
        </div>
        <div class="col-md-3">
          <%= f.label :start_date, "Start Date (Compare From)", class: "form-label" %>
          <%= f.date_field :start_date, value: params[:start_date], class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= f.label :end_date, "End Date (Compare To)", class: "form-label" %>
          <%= f.date_field :end_date, value: params[:end_date], class: "form-control" %>
        </div>
        <div class="col-12">
          <%= f.submit "Filter", class: "btn btn-primary" %>
          <%= link_to "Reset", root_path, class: "btn btn-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <% if @trending_items.any? %>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th>Name</th>
            <th>Rarity</th>
            <th>Wear</th>
            <th>Latest Price</th>
            <th>Sold Today</th>
            <th>Buy Order Vol</th>
            <th>Offer Vol</th>
          </tr>
        </thead>
        <tbody>
          <% @trending_items.each do |item| %>
            <tr>
              <td>
                <%= link_to item.name, "https://steamcommunity.com/market/listings/730/#{ERB::Util.url_encode(item.name)}", target: "_blank", class: "text-decoration-none fw-bold" %>
                <br>
                <small class="text-muted">
                  Comparing <%= item.prev_date %> vs <%= item.current_date %>
                </small>
              </td>
              <td>
                <% if item.rarity.present? %>
                  <span class="badge bg-secondary"><%= item.rarity %></span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% if item.wear.present? %>
                  <span class="badge bg-light text-dark border"><%= item.wear %></span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <%= number_to_currency(item.latest_steam_price) %>
                <% if item.current_price.present? && item.prev_price.present? %>
                  <% price_diff = item.current_price - item.prev_price %>
                  <% if price_diff > 0 %>
                    <span class="badge bg-success"><i class="bi bi-arrow-up"></i> +<%= number_to_currency(price_diff) %></span>
                  <% elsif price_diff < 0 %>
                    <span class="badge bg-danger"><i class="bi bi-arrow-down"></i> <%= number_to_currency(price_diff) %></span>
                  <% else %>
                    <span class="badge bg-secondary">=</span>
                  <% end %>
                <% end %>
              </td>
              <td>
                <%= item.current_soldtoday %>
                <span class="badge bg-success"><i class="bi bi-arrow-up"></i> +<%= item.current_soldtoday.to_i - item.prev_soldtoday.to_i %></span>
              </td>
              <td>
                <%= item.current_buyordervolume %>
                <span class="badge bg-success"><i class="bi bi-arrow-up"></i> +<%= item.current_buyordervolume.to_i - item.prev_buyordervolume.to_i %></span>
              </td>
              <td>
                <%= item.current_offervolume %>
                <span class="badge bg-danger"><i class="bi bi-arrow-down"></i> <%= item.current_offervolume.to_i - item.prev_offervolume.to_i %></span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="alert alert-info">
      No trending items found matching your criteria.
    </div>
  <% end %>
</div>
