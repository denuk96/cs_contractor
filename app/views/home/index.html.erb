<div class="container mt-4" data-controller="popover">
  <h1 class="mb-4">Trending Skin Items</h1>

  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: root_path, method: :get, class: "row g-3" do |f| %>
        <div class="col-md-3">
          <%= f.label :name, "Item Name", class: "form-label" %>
          <%= f.text_field :name, value: params[:name], class: "form-control", placeholder: "Search by name..." %>
        </div>
        <div class="col-md-3">
          <%= f.label :category, "Category", class: "form-label" %>
          <%= f.select :category, Skin::ITEM_TYPES, { include_blank: "All Categories", selected: params[:category] }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= f.label :collection, "Collection", class: "form-label" %>
          <%= f.select :collection, Skin.distinct.pluck(:collection_name).compact.sort, { include_blank: "All Collections", selected: params[:collection] }, { class: "form-select", multiple: true, size: 5 } %>
        </div>
        <div class="col-md-3">
          <%= f.label :rarity, class: "form-label" %>
          <%= f.select :rarity, SkinItem.rarities.to_a, { include_blank: "All Rarities", selected: params[:rarity] }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= f.label :wear, "Quality", class: "form-label" %>
          <%= f.select :wear, SkinItem.wears.to_a, { include_blank: "All Qualities", selected: params[:wear] }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= f.label :stattrak, "StatTrakâ„¢", class: "form-label" %>
          <%= f.select :stattrak, [["Any", ""], ["Yes", "true"], ["No", "false"]], { selected: params[:stattrak] || 'false' }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= f.label :souvenir, "Souvenir", class: "form-label" %>
          <%= f.select :souvenir, [["Any", ""], ["Yes", "true"], ["No", "false"]], { selected: params[:souvenir] || 'false' }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= f.label :sort_by, "Sort By", class: "form-label" %>
          <%= f.select :sort_by, [
            ["Trending Score", ""],
            ["Top Signals (Pump Alert)", "top_signals"],
            ["Price: Low to High", "price_asc"],
            ["Price: High to Low", "price_desc"],
            ["Volume/Price Divergence", "volume_price_divergence"],
            ["Supply Dry Up (Turnover)", "supply_dry_up"],
            ["Buy Order Increase", "buy_order_increase"],
            ["No Sorting", "none"]
          ], { selected: params[:sort_by] }, { class: "form-select" } %>
        </div>
        <div class="col-md-3">
          <%= f.label :min_price, "Min Price", class: "form-label" %>
          <%= f.number_field :min_price, value: params[:min_price], class: "form-control", step: 0.01 %>
        </div>
        <div class="col-md-3">
          <%= f.label :max_price, "Max Price", class: "form-label" %>
          <%= f.number_field :max_price, value: params[:max_price], class: "form-control", step: 0.01 %>
        </div>
        <div class="col-md-3">
          <%= f.label :min_offervolume, "Min Offer Vol", class: "form-label" %>
          <%= f.number_field :min_offervolume, value: params[:min_offervolume], class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= f.label :max_offervolume, "Max Offer Vol", class: "form-label" %>
          <%= f.number_field :max_offervolume, value: params[:max_offervolume], class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= f.label :start_date, "Start Date (Compare From)", class: "form-label" %>
          <%= f.date_field :start_date, value: params[:start_date], class: "form-control" %>
        </div>
        <div class="col-md-3">
          <%= f.label :end_date, "End Date (Compare To)", class: "form-label" %>
          <%= f.date_field :end_date, value: params[:end_date], class: "form-control" %>
        </div>
        <div class="col-12">
          <%= f.submit "Filter", class: "btn btn-primary" %>
          <%= link_to "Reset", root_path, class: "btn btn-secondary" %>
          <%= link_to "Export CSV", root_path(request.query_parameters.merge(format: :csv)), class: "btn btn-success float-end me-2", data: { turbo: false } %>
          <%= link_to "Export JSON", root_path(request.query_parameters.merge(format: :json)), class: "btn btn-outline-success float-end", data: { turbo: false } %>
        </div>
      <% end %>
    </div>
  </div>

  <% if @trending_items.any? %>
    <div class="d-flex justify-content-center">
      <%= paginate @trending_items %>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th>Name</th>
            <th>Collection</th>
            <th>Rarity</th>
            <th>
              Latest Price
              <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="Price Change" data-bs-content="Shows the price change between the two comparison dates."></i>
            </th>
            <th>
              Sold / Offer Vol (Turnover)
              <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="Turnover Rate (Supply Squeeze)" data-bs-content="Formula: Sold (24h) / Offer Vol. <br>Measures how fast supply is being eaten. <br><b>0-5% (Dead):</b> Too much supply. <br><b>5-15% (Organic):</b> Healthy demand. <br><b>20-50% (Squeeze):</b> High alert! Supply vanishing. <br><b>>50% (Moon):</b> Market broken, extreme volatility."></i>
            </th>
            <th>
              Buy Order Vol
              <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="Buy Order Volume" data-bs-content="The total number of active buy orders. <br>The badge shows the change over the selected period. <br>Rising buy orders with flat price can indicate accumulation."></i>
            </th>
            <th>
              Buy Wall
              <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="Buy Wall Ratio" data-bs-content="Formula: Buy Orders / Offer Vol. <br><b>5x-10x:</b> Normal support. <br><b>>50x (PUMP ALERT):</b> Someone has cornered the market. The massive buy wall prevents the price from dropping."></i>
            </th>
            <th>
              Total Quantity
              <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="Total Quantity" data-bs-content="Total quantity available across all markets."></i>
            </th>
          </tr>
        </thead>
        <tbody>
          <% @trending_items.each do |item| %>
            <tr>
              <td>
                <%= link_to skin_item_path(item), class: "me-2", target: "_blank" do %>
                  <i class="bi bi-graph-up"></i>
                <% end %>
                <%= link_to item.name, "https://steamcommunity.com/market/listings/730/#{ERB::Util.url_encode(item.name)}", target: "_blank", class: "text-decoration-none fw-bold" %>
                <% if item.prev_date.present? %>
                  <br>
                  <small class="text-muted">
                    Comparing <%= item.prev_date %> vs <%= item.current_date %>
                  </small>
                <% elsif item.current_date.present? %>
                  <br>
                  <small class="text-muted">
                    Data for <%= item.current_date %>
                  </small>
                <% end %>
              </td>
              <td>
                <%
                  collection_name = item.collection_name
                  if collection_name.blank? && item.skin_crates.present?
                    crates = JSON.parse(item.skin_crates) rescue []
                    collection_name = crates.first
                  end
                %>
                <% if collection_name.present? %>
                  <%= collection_name %>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <%
                  rarity = item.skin_rarity || item.rarity
                  if rarity.present?
                    rarity_color = case rarity
                      when "Consumer Grade", "Base Grade", "Default" then "bg-secondary"
                      when "Industrial Grade" then "bg-info text-dark"
                      when "Mil-Spec Grade", "High Grade" then "bg-primary"
                      when "Restricted", "Remarkable", "Exotic" then "bg-purple"
                      when "Classified", "Exceptional" then "bg-pink"
                      when "Covert", "Master" then "bg-danger"
                      when "Extraordinary", "Contraband" then "bg-warning text-dark"
                      else "bg-secondary"
                    end

                    style = case rarity
                      when "Restricted", "Remarkable", "Exotic" then "background-color: #8847ff !important; color: white;"
                      when "Classified", "Exceptional" then "background-color: #d32ce6 !important; color: white;"
                      else ""
                    end
                %>
                  <span class="badge <%= rarity_color %>" style="<%= style %>"><%= rarity %></span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <%= number_to_currency(item.latest_steam_price) %>
                <% if item.current_price.present? && item.prev_price.present? %>
                  <% price_diff = item.current_price - item.prev_price %>
                  <% if price_diff > 0 %>
                    <span class="badge bg-success"><i class="bi bi-arrow-up"></i> +<%= number_to_currency(price_diff) %></span>
                  <% elsif price_diff < 0 %>
                    <span class="badge bg-danger"><i class="bi bi-arrow-down"></i> <%= number_to_currency(price_diff) %></span>
                  <% else %>
                    <span class="badge bg-secondary">=</span>
                  <% end %>
                <% end %>
              </td>
              <td>
                <% if item.current_soldtoday.present? %>
                  <%= item.current_soldtoday %> / <%= item.current_offervolume %>
                  <% if item.current_offervolume.to_i > 0 %>
                    <% turnover_ratio = item.current_soldtoday.to_f / item.current_offervolume.to_f %>
                    <span class="badge bg-info text-dark"><%= number_to_percentage(turnover_ratio * 100, precision: 1) %></span>
                  <% end %>
                  <% if item.prev_soldtoday.present? %>
                    <br>
                    <small class="text-muted">
                      <% sold_diff = item.current_soldtoday.to_i - item.prev_soldtoday.to_i %>
                      <% if sold_diff > 0 %>
                        <span class="badge bg-danger">Sold: +<%= sold_diff %></span>
                      <% elsif sold_diff < 0 %>
                        <span class="badge bg-success">Sold: <%= sold_diff %></span>
                      <% end %>

                      <% offer_diff = item.current_offervolume.to_i - item.prev_offervolume.to_i %>
                      <% if offer_diff > 0 %>
                        <span class="badge bg-success">Offer: +<%= offer_diff %></span>
                      <% elsif offer_diff < 0 %>
                        <span class="badge bg-danger">Offer: <%= offer_diff %></span>
                      <% end %>
                    </small>
                  <% end %>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% if item.current_buyordervolume.present? %>
                  <%= item.current_buyordervolume %>
                  <% if item.prev_buyordervolume.present? %>
                    <% diff = item.current_buyordervolume.to_i - item.prev_buyordervolume.to_i %>
                    <% if item.prev_buyordervolume.to_i > 0 %>
                      <% percent_change = (diff.to_f / item.prev_buyordervolume.to_f) * 100 %>
                    <% else %>
                      <% percent_change = 0 %>
                    <% end %>

                    <% if diff > 0 %>
                      <span class="badge bg-danger">
                        <i class="bi bi-arrow-up"></i> +<%= diff %> (<%= number_to_percentage(percent_change, precision: 1) %>)
                      </span>
                    <% elsif diff < 0 %>
                      <span class="badge bg-success">
                        <i class="bi bi-arrow-down"></i> <%= diff %> (<%= number_to_percentage(percent_change, precision: 1) %>)
                      </span>
                    <% else %>
                      <span class="badge bg-secondary">=</span>
                    <% end %>
                  <% end %>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% if item.current_buyordervolume.present? && item.current_offervolume.to_i > 0 %>
                  <% buy_wall_ratio = item.current_buyordervolume.to_f / item.current_offervolume.to_f %>
                  <span class="<%= 'text-danger fw-bold' if buy_wall_ratio >= 50 %>">
                    <%= number_with_precision(buy_wall_ratio, precision: 2) %>x
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
              <td>
                <% if item.current_all_markets_quantity.present? %>
                  <%= item.current_all_markets_quantity %>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-center">
      <%= paginate @trending_items %>
    </div>
  <% else %>
    <div class="alert alert-info">
      No trending items found matching your criteria.
    </div>
  <% end %>
</div>
