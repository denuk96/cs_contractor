<div class="container mt-4" data-controller="popover">
  <h1 class="mb-4">
    <%= @skin_item.name %>
    <%= link_to "https://steamcommunity.com/market/listings/730/#{ERB::Util.url_encode(@skin_item.name)}", target: "_blank", class: "btn btn-outline-primary btn-sm ms-2" do %>
      <i class="bi bi-steam"></i> View on Steam
    <% end %>
  </h1>

  <!-- Analysis Section (Top) -->
  <div class="row mb-5">
    <div class="col-md-4">
      <h4>
        Volume/Price Divergence
        <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="What is this?" data-bs-content="This signal looks for a spike in sales volume while the price stays flat. It's a strong indicator that a manipulator is quietly buying up supply without letting the price rise."></i>
      </h4>
      <% if @volume_change.present? && @price_change.present? %>
        <div class="card h-100">
          <div class="card-header">Week-over-Week Change</div>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <strong>Sales Volume (7d):</strong>
              <span class="badge bg-<%= @volume_change > 0 ? 'success' : 'danger' %> float-end">
                <%= number_to_percentage(@volume_change, precision: 2) %>
              </span>
            </li>
            <li class="list-group-item">
              <strong>Price:</strong>
              <span class="badge bg-<%= @price_change > 0 ? 'success' : 'danger' %> float-end">
                <%= number_to_percentage(@price_change, precision: 2) %>
              </span>
            </li>
          </ul>
          <div class="card-body">
            <% if @volume_change > 20 && @price_change.abs < 5 %>
              <h5 class="card-title text-danger">Divergence Detected (Strong Signal)</h5>
              <p class="card-text">Sales volume is spiking, but the price is remaining flat. This is a strong indicator of accumulation.</p>
            <% else %>
              <h5 class="card-title text-success">Normal Market Activity</h5>
              <p class="card-text">No significant divergence detected.</p>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="alert alert-info">Not enough data for divergence analysis.</div>
      <% end %>
    </div>

    <div class="col-md-4">
      <h4>
        Supply "Dry Up" (Turnover)
        <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="What is this?" data-bs-content="This measures how fast the available supply is being sold. A high turnover rate means demand is eating up supply, which can lead to a price spike (a 'squeeze')."></i>
      </h4>
      <div class="card h-100">
        <div class="card-header">
          Current Turnover Rate: <strong><%= number_to_percentage(@current_turnover, precision: 2) %></strong>
        </div>
        <div class="card-body">
          <% if @current_turnover <= 5 %>
            <h5 class="card-title text-muted">"Dead" Zone (0-5%)</h5>
            <p class="card-text">Supply is massive; demand is low. Very hard to manipulate.</p>
          <% elsif @current_turnover <= 15 %>
            <h5 class="card-title text-success">"Organic" Zone (5-15%)</h5>
            <p class="card-text">Healthy activity. Watch for a slow rise while price is stable (accumulation).</p>
          <% elsif @current_turnover <= 50 %>
            <h5 class="card-title text-warning">"Squeeze" Zone (20-50%)</h5>
            <p class="card-text">High Alert. A large portion of supply is vanishing daily. Potential for artificial buying.</p>
          <% else %>
            <h5 class="card-title text-danger">"Moon" Zone (>50%)</h5>
            <p class="card-text">The market is broken. Demand is outpacing supply. Extreme volatility is likely.</p>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <h4>
        "Buy Wall" Ratio
        <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="What is this?" data-bs-content="This is the ratio of buy orders to sell listings. A high ratio (>50x) indicates a 'buy wall' where a large number of buy orders prevents the price from falling, suggesting someone has cornered the market."></i>
      </h4>
      <% if @buy_wall_ratio.present? %>
        <div class="card h-100">
          <div class="card-header">
            Wall Strength:
            <strong class="<%= 'text-danger' if @buy_wall_ratio > 50 %>">
              <%= number_with_precision(@buy_wall_ratio, precision: 2) %>x
            </strong>
          </div>
          <div class="card-body">
            <% if @buy_wall_ratio <= 10 %>
              <h5 class="card-title text-success">Normal (5x-10x)</h5>
              <p class="card-text">A healthy number of buy orders are present, providing a stable price floor.</p>
            <% else %>
              <h5 class="card-title text-danger">PUMP ALERT (>50x)</h5>
              <p class="card-text">An extreme number of buy orders compared to sell listings. The market may be cornered.</p>
            <% end %>
          </div>
        </div>
      <% else %>
        <div class="alert alert-info">Not enough data for buy wall analysis.</div>
      <% end %>
    </div>
  </div>

  <!-- Item Details Section -->
  <div class="row mb-5">
    <div class="col-md-12">
      <h3>Item Details</h3>
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <dl class="row mb-0">
                <dt class="col-sm-4">Collection</dt>
                <dd class="col-sm-8">
                  <%
                    collection_name = @skin_item.collection_name
                    if collection_name.blank? && @skin_item.skin_crates.present?
                      crates = JSON.parse(@skin_item.skin_crates) rescue []
                      collection_name = crates.first
                    end
                  %>
                  <%= collection_name || '-' %>
                </dd>

                <dt class="col-sm-4">Rarity</dt>
                <dd class="col-sm-8">
                  <%
                    rarity = @skin_item.skin_rarity || @skin_item.rarity
                    if rarity.present?
                      rarity_color = case rarity
                        when "Consumer Grade", "Base Grade", "Default" then "bg-secondary"
                        when "Industrial Grade" then "bg-info text-dark"
                        when "Mil-Spec Grade", "High Grade" then "bg-primary"
                        when "Restricted", "Remarkable", "Exotic" then "bg-purple"
                        when "Classified", "Exceptional" then "bg-pink"
                        when "Covert", "Master" then "bg-danger"
                        when "Extraordinary", "Contraband" then "bg-warning text-dark"
                        else "bg-secondary"
                      end

                      style = case rarity
                        when "Restricted", "Remarkable", "Exotic" then "background-color: #8847ff !important; color: white;"
                        when "Classified", "Exceptional" then "background-color: #d32ce6 !important; color: white;"
                        else ""
                      end
                  %>
                    <span class="badge <%= rarity_color %>" style="<%= style %>"><%= rarity %></span>
                  <% else %>
                    -
                  <% end %>
                </dd>

                <dt class="col-sm-4">Wear</dt>
                <dd class="col-sm-8"><%= @skin_item.wear || '-' %></dd>

                <dt class="col-sm-4">Current Price</dt>
                <dd class="col-sm-8 fw-bold"><%= number_to_currency(@skin_item.latest_steam_price) %></dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row mb-0">
                <dt class="col-sm-4">Turnover Rate</dt>
                <dd class="col-sm-8">
                  <%= number_to_percentage(@current_turnover, precision: 1) %>
                  <% if @current_turnover > 50 %>
                    <span class="badge bg-danger">Moon Zone</span>
                  <% elsif @current_turnover > 20 %>
                    <span class="badge bg-warning text-dark">Squeeze Zone</span>
                  <% elsif @current_turnover > 5 %>
                    <span class="badge bg-success">Organic Zone</span>
                  <% else %>
                    <span class="badge bg-secondary">Dead Zone</span>
                  <% end %>
                </dd>

                <dt class="col-sm-4">Buy Order Vol</dt>
                <dd class="col-sm-8">
                  <% latest_history = @skin_item.skin_item_histories.order(date: :asc).last %>
                  <% if latest_history&.buyordervolume.present? %>
                    <%= latest_history.buyordervolume %>
                  <% else %>
                    -
                  <% end %>
                </dd>

                <dt class="col-sm-4">Buy Wall Ratio</dt>
                <dd class="col-sm-8">
                  <% if @buy_wall_ratio.present? %>
                    <span class="<%= 'text-danger fw-bold' if @buy_wall_ratio >= 50 %>">
                      <%= number_with_precision(@buy_wall_ratio, precision: 2) %>x
                    </span>
                    <% if @buy_wall_ratio >= 50 %>
                      <span class="badge bg-danger">PUMP ALERT</span>
                    <% end %>
                  <% else %>
                    -
                  <% end %>
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row">
    <!-- 0. Supply Runover Dashboard (New) -->
    <div class="col-md-12 mb-5">
      <h3>
        0. The "Supply Runover" Dashboard
        <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="Supply vs Demand" data-bs-content="Directly compares the daily Sold Volume against the available Offer Volume. If the blue line (Sold) consistently approaches or crosses the black line (Offers), a supply squeeze is imminent."></i>
      </h3>
      <%= line_chart @supply_runover_data, library: {
        scales: {
          'volume-axis': {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Volume' }
          }
        }
      } %>
    </div>

    <!-- 1. Accumulation Dashboard -->
    <div class="col-md-12 mb-5">
      <h3>
        1. The "Accumulation" Dashboard (Early Warning)
        <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="The X-Cross Pattern" data-bs-content="Look for the 'X-Cross': Offer Volume (Supply) trends DOWN while Buy Orders (Demand) trend UP. If the Price stays FLAT during this, it's a strong signal that someone is secretly absorbing supply."></i>
      </h3>
      <%= line_chart @accumulation_data, library: {
        scales: {
          'volume-axis': {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Volume' }
          },
          'price-axis': {
            type: 'linear',
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: { callback: "function(value) { return '$' + value.toLocaleString(); }" },
            title: { display: true, text: 'Price (USD)' }
          }
        }
      } %>
    </div>

    <!-- 2. Elasticity Dashboard -->
    <div class="col-md-12 mb-5">
      <h3>
        2. The "Elasticity" Dashboard (The Trigger)
        <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="The Tension Spike" data-bs-content="Look for the 'Tension' Spike: The Buy Wall Ratio spikes massively (e.g., >50x) while the Turnover Rate is moderate. If Turnover then jumps, the price has nowhere to go but up."></i>
      </h3>
      <%= line_chart @elasticity_data, library: {
        scales: {
          'ratio-axis': {
            type: 'linear',
            position: 'left',
            ticks: { callback: "function(value) { return value.toFixed(1) + 'x'; }" },
            title: { display: true, text: 'Buy Wall Ratio' }
          },
          'percent-axis': {
            type: 'linear',
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: { callback: "function(value) { return value.toFixed(1) + '%'; }" },
            title: { display: true, text: 'Turnover Rate (%)' }
          }
        }
      } %>
    </div>

    <!-- 3. Fakeout Dashboard -->
    <div class="col-md-12 mb-5">
      <h3>
        3. The "Fakeout" Dashboard (The Trap)
        <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="The Hollow Volume" data-bs-content="Look for 'Hollow' Volume: Sold Volume is exploding, but the Price is barely moving. This is a classic sign of wash trading to create fake hype. Real demand always moves price."></i>
      </h3>
      <%= line_chart @fakeout_data, library: {
        scales: {
          'volume-axis': {
            type: 'linear',
            position: 'left',
            title: { display: true, text: 'Sold Volume' }
          },
          'price-axis': {
            type: 'linear',
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: { callback: "function(value) { return '$' + value.toLocaleString(); }" },
            title: { display: true, text: 'Price (USD)' }
          }
        }
      } %>
    </div>

    <!-- 4. The Squeeze Chart (God Mode) -->
    <div class="col-md-12 mb-5">
      <h3>
        4. The "Squeeze" Chart (God Mode)
        <i class="bi bi-info-circle" data-bs-toggle="popover" data-bs-trigger="hover" title="The 'Go' Signal" data-bs-content="The 'Go' Signal: When the Green Line (Buy Wall) is at an All-Time High and the Red Line (Supply) is at an All-Time Low, the next bar of Grey (Volume) will cause a vertical price spike."></i>
      </h3>
      <%= line_chart @squeeze_data, library: {
        scales: {
          'ratio-axis': {
            type: 'linear',
            position: 'left',
            ticks: { callback: "function(value) { return value.toFixed(1) + 'x'; }" },
            title: { display: true, text: 'Buy Wall Ratio' }
          },
          'volume-axis': {
            type: 'linear',
            position: 'right',
            grid: { drawOnChartArea: false },
            title: { display: true, text: 'Volume' }
          }
        }
      } %>
    </div>
  </div>

  <%= link_to "Back to Trending", root_path, class: "btn btn-secondary mb-5" %>
</div>
